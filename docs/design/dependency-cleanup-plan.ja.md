# 依存整理の計画

## 1. 背景

`docs/draft/export-index-conventions.md` で定義したルールでは、`src/` の各ディレクトリが `index.ts` を通じてのみ機能を公開し、外部は個別ファイルではなくディレクトリを参照するよう求めています。この運用を徹底するには既存コードを調査し、import/export を整え、依存関係が循環しないよう管理する必要があります。

## 2. 目的

- 現在の `src/` 内のエクスポートとインポートの状態を調査し、新ルールに反する箇所を特定する。
- 各ディレクトリの `index.ts` が公開 API を集約し、実行コードを含まず再エクスポートのみになるよう標準化する。
- ディレクトリ横断の参照をエントリーポイントに切り替えて、ファイルレベルの依存を排除し、循環を防止する。
- 今後もこのパターンを維持できるよう `tsconfig` や ESLint の設定を強化する。

## 3. 範囲

- `src/` 以下で再利用される公開エンティティをもつディレクトリすべてを対象とする。
- 値のエクスポートと型のエクスポートを区別しつつ、必要に応じて `export type` を使い分ける。
- リファクタリングの過程で見つかる循環依存を継続的に監視し、回避する。

## 4. 実施計画

| ステップ | 内容 | 依存関係 | 受け入れ条件 |
| -------- | ---- | -------- | ------------ |
| 1. エクスポート調査 | `rg` などによりディレクトリごとのエクスポート・インポート関係を一覧化し、直接ファイルを参照している箇所を洗い出す。 | `tsconfig.paths` によるエイリアスの理解。 | 各ディレクトリについて、公開物とそれを利用する消費先が記録されている。直接ファイルを指定している import をすべてリスト化できる。 |
| 2. `index.ts` 整備 | 足りない `index.ts` を追加し、全公開 API を再エクスポートする。ロジックは含めず `export` 文のみとする。 | ステップ 1 の調査結果。 | 全ディレクトリの `index.ts` が公開 API を一元化し、内部ファイルを直接参照しない。 |
| 3. 消費側のリファクタ | `../foo/bar` のような直接 import を `from "@/src/foo"` のようなディレクトリ単位 import に置き換える。 | ステップ 2 で必要なシンボルが `index.ts` に揃っていること。 | 他ディレクトリは自ディレクトリ以外のファイルパスに触れておらず、型チェックが通る。 |
| 4. 循環抑止 | A→B→A のような構造が出たら共通型を `types/` に切り出す、あるいは `export type` + 遅延初期化に変更する。 | ステップ 2-3 で既存の循環が表面化。 | 循環は排除されるか型のみの依存に置き換わり、ランタイム初期化順が確定する。 |
| 5. ツールチェーン強化 | `tsconfig.json` のエイリアスや ESLint のルールを更新し、今後もディレクトリ import を促進・直接ファイル import を検出できるようにする。 | ステップ 1-4 で得た知見。 | ファイル単位 import に対して lint で警告/エラーが出るなど、ルールが強化されている。 |
| 6. 検証 | 全体のビルド・テストを実行し、export/import の解決に問題がないことを確認する。 | 上記すべてのステップ完了。 | テスト/ビルドが成功し、型エラーも発生していない。 |

## 5. テスト・検証

- `npm run lint` や `npm run test`（プロジェクト固有のコマンド）を各リファクタ後に実行し、import 時の実行時/型エラーを検出する。
- 必要であれば ESLint `no-restricted-imports` を使って直接ファイル指定を防ぐルールを追加する。

## 6. リスクと対策

- **循環依存**: 共有する抽象（型やインターフェース）は `types/` に分離し、値やインスタンスによる循環に変換させない。型のみの依存にならない場合は遅延初期化のファクトリに委譲する。
- **エクスポート漏れ**: `index.ts` を更新する際はディレクトリ単位のチェックリストを使い、必要なシンボルをすべて含める。

## 7. 次のステップ

1. 本計画をチームと共有し、優先的に扱うディレクトリ（例: `src/shared` → `src/features` → `src/ui`）を確認する。
2. 上記表の順で作業を進め、編集の都度ドキュメント/知見を蓄積する。
